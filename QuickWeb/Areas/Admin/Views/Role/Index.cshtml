
@{
    ViewBag.Title = "角色列表";
    ViewBag.GlobalStyle = "animated fadeInRight";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

@section styles{
    <link href="~/Content/admin/css/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet">
    <link rel="stylesheet" href="~/Assets/zTree/zTreeStyle.css" type="text/css">
}
<div class="wrapper wrapper-content animated fadeInRight">
    <!-- Panel Other -->
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>角色列表</h5>
        </div>
        <div class="ibox-content">
            <div class="form-group clearfix col-sm-1">
                @if(Auth.Check("role/roleadd"))
                {
                    <a href="@Url.Action("RoleAdd")" class="btn btn-outline btn-primary">添加角色</a>
                }
            </div>
            <!--搜索框开始-->
            <form id='commentForm' role="form" method="post" class="form-inline pull-right">
                <div class="content clearfix m-b">
                    <div class="form-group">
                        <label>管理员名称：</label>
                        <input type="text" class="form-control" id="rolename" name="rolename">
                    </div>
                    <div class="form-group">
                        <button class="btn btn-primary" type="button" style="margin-top:5px" id="search">
                            <strong>搜 索</strong>
                        </button>
                    </div>
                </div>
            </form>
            <!--搜索框结束-->
            <div class="example-wrap">
                <div class="example">
                    <table id="cusTable">
                        <thead>
                        <tr>
                            <th data-field="id">角色ID</th>
                            <th data-field="role_name">角色名称</th>
                            <th data-field="operate">操作</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <!-- End Example Pagination -->
        </div>
    </div>
    <!-- End Panel Other -->
</div>
<!-- 角色分配 -->
<div class="zTreeDemoBackground left" style="display: none;z-index:1000000;" id="role">
    <input type="hidden" id="node_id">
    <div class="form-group">
        <div class="col-sm-5 col-sm-offset-2">
            <ul id="treeType" class="ztree"></ul>
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-4 col-sm-offset-4" style="margin-bottom: 15px">
            <input type="button" value="确认分配" class="btn btn-primary" id="postform" />
        </div>
    </div>
</div>

@section scripts{
    <script src="~/Content/admin/js/plugins/bootstrap-table/bootstrap-table.min.js"></script>
    <script src="~/Content/admin/js/plugins/bootstrap-table/bootstrap-table-mobile.min.js"></script>
    <script src="~/Content/admin/js/plugins/bootstrap-table/locale/bootstrap-table-zh-CN.min.js"></script>
    <script src="~/Content/admin/js/plugins/suggest/bootstrap-suggest.min.js"></script>
    <script src="~/Assets/layer/layer.min.js"></script>
    <script type="text/javascript" src="~/Assets/zTree/jquery.ztree.core-3.5.js"></script>
    <script type="text/javascript" src="~/Assets/zTree/jquery.ztree.excheck-3.5.js"></script>
    <script type="text/javascript" src="~/Assets/zTree/jquery.ztree.exedit-3.5.js"></script>
    <script type="text/javascript">
        var zNodes = '';
        var index = '';
    </script>
    <script type="text/javascript">
        function initTable() {
            //先销毁表格
            $('#cusTable').bootstrapTable('destroy');
            //初始化表格,动态从服务器加载数据
            $("#cusTable").bootstrapTable({
                method: "get",  //使用get请求到服务器获取数据
                url: "@Url.Action("GetData")", //获取数据的地址
                striped: true,  //表格显示条纹
                pagination: true, //启动分页
                pageSize: 10,  //每页显示的记录数
                pageNumber: 1, //当前第几页
                pageList: [5, 10, 15, 20, 25],  //记录数可选列表
                sidePagination: "server", //表示服务端请求
                paginationFirstText: "首页",
                paginationPreText: "上一页",
                paginationNextText: "下一页",
                paginationLastText: "尾页",
                queryParamsType: "undefined",
                queryParams: function queryParams(params) {   //设置查询参数
                    var param = {
                        pageIndex: params.pageNumber,
                        pageSize: params.pageSize,
                        searchText: $('#rolename').val()
                    };
                    return param;
                },
                onLoadSuccess: function(res){  //加载成功时执行
                    if(1 == res.status){
                        window.location.reload();
                    }
                    //layer.msg("加载成功", {time : 1000});
                },
                onLoadError: function(){  //加载失败时执行
                    layer.msg("加载数据失败");
                },
                columns: [
                    {
                        field: "id"
                    },{
                        field: "role_name"
                    }, {
                        field: "operate",
                        formatter: function (value, row, index) {
                            if(row.id == 1)
                                return "-";
                            var btn = '';
                            if ('True' == '@Auth.Check("role/roleedit")')
                                btn += '<a href="@(Url.Action("RoleEdit"))/'+ row.id +'" class="btn btn-primary btn-sm"><i class="fa fa-paste"></i> 编辑</a> ';
                            if ('True' == '@Auth.Check("role/roledel")')
                                btn += ' <a href="javascript:roleDel(' + row.id + ')" class="btn btn-danger btn-sm"><i class="fa fa-trash-o"></i> 删除</a> ';
                            if ('True' == '@Auth.Check("role/giveaccess")')
                                btn += ' <a href="javascript:giveQx(' + row.id + ')" class="btn btn-info btn-sm"><i class="fa fa-institution"></i> 分配权限</a>';
                            return btn;                             
                        }
                    }]
            });
        }

        $(document).ready(function () {
            //调用函数，初始化表格
            initTable();

            //当点击查询按钮的时候执行
            $("#search").bind("click", initTable);

        });

        function roleDel(id) {
            var index = layer.confirm('确认删除此角色?', {icon: 3, title:'提示'}, function(){
                //do something
                $.post("@Url.Action("RoleDel")", {'id' : id}, function(res){
                    layer.close(index);
                    if(1 == res.status){
                        layer.alert("数据删除成功！", { title: '友情提示', icon: 1, closeBtn: 0 }, function (self){
                            layer.close(self);
                            initTable();
                        });
                    }else if(0 == res.status){
                        layer.alert(res.msg, { title: '友情提示', icon: 2 });
                    }else{
                        window.location.reload();
                    }
                });
            });
        }

        //分配权限
        function giveQx(id) {
            $("#node_id").val(id);
            //加载层
            var loading = layer.load(0, { shade: false }); //0代表加载的风格，支持0-2
            // 获取权限信息
            $.getJSON("@Url.Action("GetAccess")", { 'id': id }, function (res) {
                layer.close(loading);
                if (1 == res.status) {
                    zNodes = res.data;  //将字符串转换成obj
                    //页面层
                    index = layer.open({
                        type: 1,
                        area: ['350px', '400px'],
                        title: '权限分配',
                        skin: 'layui-layer-demo', //加上边框
                        content: $('#role')
                    });

                    //设置 zetree
                    var setting = {
                        check: {
                            enable: true
                        },
                        data: {
                            simpleData: {
                                enable: true
                            }
                        }
                    };
                    $.fn.zTree.init($("#treeType"), setting, zNodes);
                    var zTree = $.fn.zTree.getZTreeObj("treeType");
                    zTree.expandAll(true);
                } else if (0 == res.status) {
                    layer.alert(res.msg, { title: '友情提示', icon: 2 });
                } else {
                    window.location.reload();
                }
            });
        }
        //确认分配权限
        $("#postform").click(function () {
            var zTree = $.fn.zTree.getZTreeObj("treeType");
            var nodes = zTree.getCheckedNodes(true);
            var rule = '';
            $.each(nodes, function (n, value) {
                if (n > 0) {
                    rule += ',';
                }
                rule += value.id;
            });
            var id = $("#node_id").val();
            //console.log(rule);
            //写入库
            $.post("@Url.Action("SetAccess")", { 'id': id, 'rule': rule }, function (res) {
                layer.close(index);
                if (1 == res.status) {
                    layer.alert(res.msg, { title: '友情提示', icon: 1, closeBtn: 0 },  function (self){
                        layer.close(self);
                        initTable();
                    });
                } else if (0 == res.status) {
                    layer.alert(res.msg, { title: '友情提示', icon: 2 });
                } else {
                    window.location.reload();
                }
            }, 'json');
        });
    </script>
}
